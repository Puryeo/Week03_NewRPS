Overhand Notes (Handover Summary - 2025-09-20)
- Scope update
  - Phase A and Phase B engine work and assets are implemented and QA complete.
  - Keep legacy content below for history. Use this section for current status.
- Engine changes implemented
  - Tag additions: Condition TurnIndexIs, Condition ConsecutiveOutcomeWithChoiceIs, Condition RerollUsedEquals, Effect RevealNextAICard.
  - GameContext: added rerollsUsed for tag conditions.
  - JokerManager:
    - TurnSettlement interpreter supports the new conditions and effect.
    - RoundStart AI hand mutation refined for Paper_Dominance: converts only AI Paper or Scissors to Rock, exact count, no duplicates.
    - TurnIndexIs OR semantics: if multiple TurnIndexIs tags exist on one Joker, pass when any matches (used by Final_Royalty for turn 4 or 5).
    - FinalScoreMultiplier applies to the turn-end total. delta = (currentTotal + delta) * mul - currentTotal.
  - GameManager:
    - GetPlayerRerollsUsed provided and piped into GameContext.rerollsUsed.
    - ShowInfo now queues settlement info and appends it under ResultText after the per-turn result, so reveal messages show in UI.
    - Helper ReplaceAIPaperOrScissorsToRock to mutate AI hand deterministically without duplicate picks.
  - Namespaces: DEBUGManager moved to NewRPS.Debugging; editor updated to reference it.
- Assets authored
  - Phase A: Scissors_Collector, Blade_of_Vengeance, Glass_Scissors, Sturdy_Barricade, Landslide, Force_Of_Nature, Devils_Contract, Paper_Dominance.
  - Phase B: Geological_Survey, Twin_Blades, Final_Royalty (TurnIndex 4 or 5), Iron_Heart (+30).
- QA outcomes (key points)
  - Force_Of_Nature: multiplies total on the turn Rock count reaches 5 (not bound to last turn 5).
  - Paper_Dominance: converts exactly 2 AI cards from Paper or Scissors to Rock; re-applies on Reroll via OnJokerToggled.
  - Geological_Survey: Loss with Rock reveals next AI front card; message appears in ResultText and console.
  - Final_Royalty: valid on turn 4 or 5 (two TurnIndexIs tags) and requires Win with Paper.
  - Iron_Heart: +30 on last turn if no reroll used.
- Authoring guidance
  - To target multiple turns, add multiple TurnIndexIs tags; runtime treats them as OR.
  - For reveal messages during settlement, use RevealNextAICard; UI appends the message under the result line for that turn.
  - For AI hand mutation to Rock, use ReplaceAIRandomCardsToChoice with choiceParam Rock; engine limits candidates to Paper or Scissors.
  - For per-turn multipliers, use FinalScoreMultiplier.
- Next steps (not implemented yet)
  - Phase C: timings RoundPrepare and TurnStart; effects AddCardsToPlayerHand, AddCardsToAIHand, ModifyTurnsToPlayDelta; condition PlayerHasAtLeastCountInHand.
  - Phase D: timing RoundEnd; effect FinalTotalMultiplier; flags like IgnoreBossPenalty; ensure single-apply order at round end.
- How to continue
  1) To add new Jokers, use Tools > NewRPS authoring menu, then adjust tags in the asset.
  2) To add new tag types, update JokerEnums, JokerTag, GameContext, and JokerManager in that order; add RPSLog logs; QA in Play Mode.
  3) Keep this file ASCII only to avoid unicode save issues.

--- legacy content below (kept for history) ---

Joker Implementation Tasks (from '# 조커 아이디어.txt')

Scope
- No code implementation in this pass. Define tags, gaps, and a safe rollout plan per idea.
- Keep compatibility with current tag interpreter; avoid breaking existing Jokers.

Handover Notes (for implementation start)
- Current state (implemented)
  - Tag engine timings: RoundStart, TurnSettlement
  - Conditions/Effects: listed below; includes PlayerHasMoreOfChoiceThanAI and ReplaceAIRandomCardsToChoice
  - GameContext: turnIndex, turnsPlanned, isLastTurn, playerHistory, outcomeHistory
  - JokerManager: round-start AI hand mutation, ForceAIDrawFromFront; validation warnings; unified RPSLog
  - Archetypes: Anchor, Payoff, Catalyst, Utility, Risk on JokerData
- Immediate next steps (Phase A, no engine code):
  - Author assets: Scissors_Collector, Blade_of_Vengeance, Glass_Scissors, Sturdy_Barricade, Landslide, Force_Of_Nature, Devils_Contract, Blueprint(Paper_Dominance)
  - Validate via Play Mode and RPSLog deltas/multipliers
- When starting Phase B/C/D (engine work) implement in this order:
  1) Small additions (Phase B): TurnIndexIs, ConsecutiveOutcomeWithChoiceIs, RevealNextAICard, RerollUsedEquals (+plumb reroll usage)
  2) Hooks & hand ops (Phase C): add RoundPrepare, TurnStart; AddCardsToPlayer/AIHand, ModifyTurnsToPlayDelta; PlayerHasAtLeastCountInHand
  3) RoundEnd total (Phase D): add FinalTotalMultiplier and RoundEnd timing; ensure single application/order
- API checklist before coding
  - JokerEnums: add Timing (RoundPrepare, TurnStart, RoundEnd), new Conditions/Effects per phases
  - GameContext: add rerollsUsed (or accessor), totalMultiplier (default=1)
  - JokerManager: add OnRoundPrepare(GameManager), OnTurnStart(GameContext); apply RoundEnd totalMultiplier once; log with RPSLog
  - GameManager: call RoundPrepare after hand generation; helpers for hand add/turns delta; GetRerollsUsed()
- Ordering/determinism rules
  - Phase order: Prepare → Start → Judge → Settlement → End
  - Multipliers: apply in pipeline order; avoid duplicate application (document single-apply)
  - RevealNextAICard: prefer front-only; require AIDrawFromFront or emit info-only message
  - RNG determinism: fixed seed/order; use toggle order as priority (last toggled = highest)
- Testing and logging
  - Use RPSLog: HandMut, TurnsMut, TurnStart, TurnResolve, RoundEnd, Reveal, Joker events
  - Extend PRD Test Checklist with RoundPrepare/TurnStart and FinalTotalMultiplier cases
- Documentation sync
  - After each phase, update PRD sections C/G/M/N and this file (completed/remaining)

Current tag capabilities (implemented)
- Timing: RoundStart, TurnSettlement
- Condition: OutcomeIs, PlayerChoiceIs, PlayedAtLeastCount, ConsecutiveDrawWithChoiceIs, IsLastTurn, PlayerHasMoreOfChoiceThanAI
- Effect: AddScoreDelta, FinalScoreMultiplier, ForceAIDrawFromFront, ShowInfo, ReplaceAIRandomCardsToChoice
- GameContext supports: playerChoice, outcome, baseScore, currentTotal, scoreDelta, turnIndex, turnsPlanned, isLastTurn, playerHistory, outcomeHistory

Gaps to consider (new tags/hooks)
- Timing
  - TurnStart: hook before outcome is determined each turn
  - RoundEnd (a.k.a. RoundSettlement): hook after last turn scoring is applied
  - RoundPrepare: hook after hand generation, before RoundStart effects (cleaner for hand size edits)
- Condition
  - TurnIndexIs: intValue exact match (or Between)
  - ConsecutiveOutcomeWithChoiceIs: outcomeParam + choiceParam repeated intValue times (generalizes Draw-only case)
  - PlayerHasAtLeastCountInHand: at RoundStart/Prepare compare current hand counts vs intValue
  - RerollUsedEquals: check rerolls used (requires GameContext.rerollsUsed or accessor)
- Effect
  - RevealNextAICard: call GameManager.PeekAIFront and display
  - AddScorePerPlayerHandCount: adds intValue per card of choiceParam in player hand (TurnStart-friendly)
  - ModifyTurnsToPlayDelta: mutate turnsToPlay by intValue at RoundPrepare/Start
  - IgnoreBossPenalty: flag for later systems (no-op now; safe to log)
  - AddCardsToPlayerHand/AddCardsToAIHand: push choiceParam cards by intValue at RoundPrepare
  - FinalTotalMultiplier: multiply final total score at RoundEnd (supports negative multipliers)

Idea-by-idea plan

[Scissors] Anchor
1) Scissors_Collector
- Spec: If played Scissors at least 2 times in round, +10 at round end.
- Tags now: Timing=TurnSettlement + Conditions: PlayedAtLeastCount(Scissors, >=2) + IsLastTurn(1) + Effect=AddScoreDelta(+10)
- Status: IMPLEMENTABLE NOW (no new tags).
- Tests: play Scissors 1/2 times; ensure single application at round end.

2) Twin_Blades
- Spec: Two consecutive wins with Scissors -> round total x2 at that turn end.
- Needs: Condition ConsecutiveOutcomeWithChoiceIs(outcome=Win, choice=Scissors, intValue=2)
- Effect: FinalScoreMultiplier(x2) (already immediate)
- Status: NEED NEW CONDITION.
- Notes: Trigger window: exactly on second win; decide if longer streak also triggers (>=2).

3) Blade_of_Vengeance
- Spec: If Loss with Scissors, +2 (text says +5; example shows +2). Choose one.
- Tags now: Timing=TurnSettlement + Conditions: OutcomeIs(Loss), PlayerChoiceIs(Scissors) + Effect=AddScoreDelta(+5)
- Status: IMPLEMENTABLE NOW.

[Scissors] Payoff
4) Perfect_Tailoring
- Spec: All wins are with Scissors only across 5 turns -> x2 at round end.
- Needs: Condition "WinsOnlyWithChoice" or derived with history:
  - Option A (NEW): WinsOnlyWithChoice(choice=Scissors)
  - Option B (EXPR): PlayedAtLeastCount(Scissors, >=1) AND NoWinWithOtherChoices (needs new)
- Status: NEED NEW CONDITION.

5) Tailors_Pride
- Spec: At round prepare, if player hand has >=4 Scissors, increase turnsToPlay by 1.
- Needs: Condition PlayerHasAtLeastCountInHand(choice=Scissors, intValue=4)
- Effect: ModifyTurnsToPlayDelta(+1)
- Timing: RoundPrepare preferred (or RoundStart as fallback).
- Status: NEED NEW CONDITION + EFFECT + TIMING (RoundPrepare).

6) Exploiting_Weakness
- Spec: At prepare, if player hand has >=3 Scissors, ignore boss penalty.
- Needs: Condition PlayerHasAtLeastCountInHand; Effect IgnoreBossPenalty (no-op for now)
- Status: NEED NEW CONDITION + EFFECT + TIMING; OUT-OF-SCOPE runtime effect until boss system exists.

[Scissors] Catalyst
7) Glass_Scissors
- Spec: Win with Scissors +10; Loss with Scissors -15.
- Tags now: Two entries with Timing=TurnSettlement + (OutcomeIs, PlayerChoiceIs) + AddScoreDelta(+10 / -15)
- Status: IMPLEMENTABLE NOW.

8) Mass_Production (Scissors)
- Spec: At prepare, both Player and AI receive +2 Scissors.
- Needs: Effects AddCardsToPlayerHand/AIHand(choice=Scissors, count=2); Timing RoundPrepare
- Status: NEED NEW EFFECTS + TIMING.

[Rock] Anchor
9) Sturdy_Barricade
- Spec: Draw with Rock -> +5.
- Tags now: Timing=TurnSettlement + Conditions: OutcomeIs(Draw), PlayerChoiceIs(Rock) + AddScoreDelta(+5)
- Status: IMPLEMENTABLE NOW.

10) Geological_Survey
- Spec: Loss with Rock -> reveal opponent next card.
- Needs: Effect RevealNextAICard (TurnSettlement)
- Status: NEED NEW EFFECT.
- Note: Decide determinism coupling with AIDrawFromFront (Scout). OK to reveal front only.

[Rock] Payoff
11) Ore_Vein
- Spec: At turn start, +2 per Rock in hand.
- Needs: Timing=TurnStart + Effect AddScorePerPlayerHandCount(choice=Rock, per=2)
- Status: NEED NEW TIMING + EFFECT.

12) Landslide
- Spec: At round end, if Rock used >=3 times, +20.
- Tags now: Timing=TurnSettlement + Conditions: PlayedAtLeastCount(Rock, >=3), IsLastTurn(1) + AddScoreDelta(+20)
- Status: IMPLEMENTABLE NOW.

13) Iron_Heart
- Spec: At round end, if no reroll used, +20.
- Needs: Condition RerollUsedEquals(0) (requires context.rerollsUsed)
- Status: NEED NEW CONDITION + GameContext plumb (expose rerolls used or derive: playerRerollMax - playerRerollsLeft).

[Rock] Catalyst
14) Resource_Explosion (Rock)
- Spec: At prepare, both sides +2 Rock.
- Needs: AddCardsToPlayerHand/AIHand; Timing RoundPrepare
- Status: NEED NEW EFFECTS + TIMING.

15) Great_Earthquake
- Spec: If turnIndex==5 and played Rock, at RoundEnd multiply FINAL TOTAL score by -1 (sign flip).
- Needs: Condition TurnIndexIs(5), PlayerChoiceIs(Rock); Timing=RoundEnd; Effect FinalTotalMultiplier(-1)
- Status: NEED NEW TIMING + EFFECT; MEDIUM RISK (final total mutation, but avoids outcome recomputation).
- Notes: Implement via RoundEnd hook or last-turn settlement with a total-multiplier field applied once.

16) Force_Of_Nature
- Spec: If Rock used 5 times in round, x2 final score.
- Tags now: Timing=TurnSettlement + Conditions: PlayedAtLeastCount(Rock, >=5), IsLastTurn(1) + FinalScoreMultiplier(x2)
- Status: IMPLEMENTABLE NOW.

[Paper] Anchor
17) Confidential_Document
- Spec: Win with Paper -> reveal opponent next card.
- Needs: Effect RevealNextAICard (TurnSettlement)
- Status: NEED NEW EFFECT.

[Paper] Payoff
18) Blank_Check
- Spec: 3 wins with Paper only -> x2 final.
- Needs: Condition WinsOnlyWithChoice(choice=Paper) or ConsecutiveOutcomeWithChoiceIs (wins total N). Better: WinsCountWithChoiceAtLeast(choice=Paper, intValue=3) AND NoWinWithOtherChoices.
- Status: NEED NEW CONDITION(S).

19) Perfect_Signature
- Spec: Paper used >=3 -> ignore boss penalty at round end.
- Needs: PlayedAtLeastCount(Paper, >=3) available; Effect IgnoreBossPenalty needed.
- Status: NEED NEW EFFECT.

20) Final_Royalty
- Spec: If turnIndex==5 and Win with Paper, +20.
- Needs: Condition TurnIndexIs(5) (new), OutcomeIs(Win), PlayerChoiceIs(Paper); Effect AddScoreDelta(+20)
- Status: NEED NEW CONDITION.

21) Blueprint (Paper_Dominance)
- Spec: At round start, if Player has more Paper than AI, replace 2 random AI cards to Rock.
- Tags now: Timing=RoundStart + Condition PlayerHasMoreOfChoiceThanAI(choice=Paper) + Effect ReplaceAIRandomCardsToChoice(to=Rock, count=2)
- Status: IMPLEMENTED IN ENGINE; just needs asset authoring.

[Paper] Catalyst
22) Devils_Contract
- Spec: Win with Paper +20; Loss with Paper -30.
- Tags now: two TurnSettlement entries with AddScoreDelta.
- Status: IMPLEMENTABLE NOW.

23) Inflation (Paper)
- Spec: At prepare, both sides +2 Paper.
- Needs: AddCardsToPlayerHand/AIHand; Timing RoundPrepare.
- Status: NEED NEW EFFECTS + TIMING.

24) Slave_Contract
- Spec: At prepare, player hand size +2, AI hand size +1 (affects generation).
- Needs: Effects ModifyPlayerHandSizeDelta(+2), ModifyAIHandSizeDelta(+1); Timing RoundPrepare; AND regenerate/deal extra cards coherently.
- Status: NEW EFFECTS + TIMING; MEDIUM RISK (hand regen coupling).

Proposed incremental implementation order (lowest risk first)
- Phase A (no new tags required): 1,3,7,9,12,16,22,21(asset only) -> author assets and validate
- Phase B (small additions):
  - Add Condition TurnIndexIs
  - Add Effect RevealNextAICard
  - Add Condition ConsecutiveOutcomeWithChoiceIs (generalized)
  - Add Condition RerollUsedEquals (and plumb reroll usage)
- Phase C (prepare/turnstart hooks and hand ops):
  - Add Timing RoundPrepare, TurnStart
  - Add Effects AddCardsToPlayerHand/AIHand, ModifyTurnsToPlayDelta
  - Add Condition PlayerHasAtLeastCountInHand
- Phase D (advanced):
  - Effects IgnoreBossPenalty (no-op flag until systems exist)
  - Effect FinalTotalMultiplier (RoundEnd hook); ensure single application and order vs other RoundEnd effects
  - Hand size deltas (Slave_Contract) with UI and validation coupling

Authoring template (example)
- Twin_Blades.asset
  - Timing: TurnSettlement
  - Conditions: ConsecutiveOutcomeWithChoiceIs(outcome=Win, choice=Scissors, intValue=2)
  - Effect: FinalScoreMultiplier(intValue=2)
- Geological_Survey.asset
  - Timing: TurnSettlement
  - Conditions: OutcomeIs(Loss), PlayerChoiceIs(Rock)
  - Effect: RevealNextAICard()
- Ore_Vein.asset (after TurnStart support)
  - Timing: TurnStart
  - Conditions: PlayerHasAtLeastCountInHand(choice=Rock, intValue>=1)
  - Effect: AddScorePerPlayerHandCount(choice=Rock, intValue=2)

Engine work items (no code now; design only)
- Define new enums in JokerEnums: TurnStart, RoundEnd, RoundPrepare (Timing); TurnIndexIs, ConsecutiveOutcomeWithChoiceIs, PlayerHasAtLeastCountInHand, RerollUsedEquals (Condition); RevealNextAICard, AddScorePerPlayerHandCount, ModifyTurnsToPlayDelta, AddCardsToPlayerHand, AddCardsToAIHand, IgnoreBossPenalty, FinalTotalMultiplier (Effect)
- Extend GameContext: rerollsUsed, playerHandCountByChoice (or query via GameManager), totalMultiplier (for RoundEnd), and expose a safe API in GameManager for hand edits and peek
- JokerManager: add switches for new tags; ensure RoundEnd phase applies totalMultiplier once; document order vs TurnSettlement
- Logging: RPSLog entries for new effects, especially hand/turns mutations and RoundEnd total mutation
- Validation: guard against negative or exceeding hand sizes; clamp and warn

Test checklist additions
- Verify RoundPrepare hooks do not conflict with RoundStart effects
- TurnStart additive scoring runs before outcome; ensure delta is included once
- RevealNextAICard deterministic when AIDrawFromFront is active; otherwise specify behavior
- FinalTotalMultiplier: round-end sign flip multiplies final total once; interacts predictably with other RoundEnd multipliers

Notes
- Boss penalty and other meta systems are out-of-scope; implement as flags with no-op until systems exist
- Keep additive pipeline predictable; prefer additive and multiplicative effects over destructive rewrites
